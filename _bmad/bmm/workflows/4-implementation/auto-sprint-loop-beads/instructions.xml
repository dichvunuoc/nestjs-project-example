<workflow>
  <critical>The workflow execution engine is governed by: {project-root}/_bmad/core/tasks/workflow.xml</critical>
  <critical>You MUST have already loaded and processed: {installed_path}/workflow.yaml</critical>
  <critical>Communicate all responses in {communication_language} and language MUST be tailored to {user_skill_level}</critical>
  <critical>Generate all documents in {document_output_language}</critical>

  <critical>
    Beads-first (REAL Beads: steveyegge/beads):

    - The canonical work system is Beads issues, not markdown story files.
    - Use the bd CLI only; never edit .beads/* files by hand.
    - Use bd dependencies (blocks, parent-child, discovered-from) and bd ready as the queue.

    Loop control via bd config:
    - bmad.loop.stop_mode = story | epic | project
    - bmad.loop.current_issue = <issue-id>
    - (optional) bmad.loop.current_epic = epic-<N> (used to keep order within an epic)

    Multi-agent integrity:
    - Prefer bd daemon / bd sync for consistency
    - Use bd validate / bd doctor when the DB looks suspicious
  </critical>

  <critical>
    BMAD Label Taxonomy (canonical):
    - bmad-story: BMAD story issue
    - needs-spec: story exists but missing BMAD STORY SPEC v1 comment
    - needs-validation: spec exists but must be validated before dev
    - ready-for-dev: spec attached; ready to implement
    - in-dev: developer currently working
    - needs-review: implementation done; awaiting review (issue remains OPEN)
    - needs-fix: review failed; required changes pending (issue remains OPEN)
    - reviewed: review completed
    - done: final completion (after review)
    - bmad-followup: follow-up issues created from review/discovery
  </critical>

  <step n="0" goal="Ensure bd is initialized and set stop mode">
    <action>Ensure `bd` is installed and available on PATH; if not, HALT with installation instructions (see https://github.com/steveyegge/beads)</action>
    <action>Run: bd init (if .beads is not present)</action>
    <action>Run: bd doctor</action>

    <action>Read stop mode: bd config get bmad.loop.stop_mode</action>
    <check if="stop_mode missing">
      <output>Ch·ªçn ch·∫ø ƒë·ªô d·ª´ng v√≤ng l·∫∑p (l∆∞u v√†o Beads ƒë·ªÉ l·∫ßn sau kh√¥ng h·ªèi):</output>
      <output>1) D·ª´ng sau khi xong 1 issue (story)</output>
      <output>2) D·ª´ng sau khi xong 1 epic</output>
      <output>3) Ch·∫°y ƒë·∫øn khi xong c·∫£ project</output>
      <ask>Nh·∫≠p 1 / 2 / 3:</ask>
      <check if="user chooses 1"><action>bd config set bmad.loop.stop_mode story</action></check>
      <check if="user chooses 2"><action>bd config set bmad.loop.stop_mode epic</action></check>
      <check if="user chooses 3"><action>bd config set bmad.loop.stop_mode project</action></check>
    </check>
  </step>

  <step n="1" goal="Pick next action by labels (no-ask)">
    <critical>
      Stop starting, start finishing:
      Prioritize clearing the board over filling the pipeline.
      Priority order: Review -> Fix -> Validate -> Dev -> Spec.

      Context safety:
      This workflow MUST process only one issue per run, then checkpoint and HALT.

      Ordering (IMPORTANT):
      - Prefer the smallest numeric story key label first (e.g., story-7-1 before story-7-2).
      - Sort key: story-(N)-(M) ascending by N then M.
      - If a story does not have a numeric story key label, fall back to lowest priority number, then oldest created.
    </critical>

    <action>1) Reviews (highest priority):</action>
    <action>Run: bd list --status open --label bmad-story,needs-review --json</action>
    <check if="any needs-review issues exist">
      <action>Select the issue with the smallest numeric story key label (story-N-M) and set {{issue_id}}</action>
      <action>Persist loop state: bd config set bmad.loop.current_issue {{issue_id}}</action>
      <action>If stop_mode is epic, also persist current epic key (from issue labels): bd config set bmad.loop.current_epic epic-<N></action>
      <action>Run: code-review-beads</action>
      <action>GOTO step 3</action>
    </check>

    <action>2) Fixes (next priority):</action>
    <action>Run: bd list --status open --label bmad-story,needs-fix --json</action>
    <check if="any needs-fix issues exist">
      <action>Select the issue with the smallest numeric story key label (story-N-M) and set {{issue_id}}</action>
      <action>Persist loop state: bd config set bmad.loop.current_issue {{issue_id}}</action>
      <action>If stop_mode is epic, also persist current epic key (from issue labels): bd config set bmad.loop.current_epic epic-<N></action>
      <action>Run: dev-story-beads</action>
      <action>GOTO step 3</action>
    </check>

    <action>3) Validate specs before starting new dev:</action>
    <action>Run: bd list --status open --label bmad-story,needs-validation --json</action>
    <check if="any needs-validation issues exist">
      <action>Select the issue with the smallest numeric story key label (story-N-M) and set {{issue_id}}</action>
      <action>Persist loop state: bd config set bmad.loop.current_issue {{issue_id}}</action>
      <action>If stop_mode is epic, also persist current epic key (from issue labels): bd config set bmad.loop.current_epic epic-<N></action>
      <action>Run: validate-story-beads</action>
      <action>GOTO step 3</action>
    </check>

    <action>4) Ready dev work:</action>
    <action>Run: bd ready --json (filter for labels ready-for-dev OR bmad-followup)</action>
    <check if="any ready dev work exists">
      <action>Select the issue with the smallest numeric story key label (story-N-M) and set {{issue_id}}</action>
      <action>Persist loop state: bd config set bmad.loop.current_issue {{issue_id}}</action>
      <action>If stop_mode is epic, also persist current epic key (from issue labels): bd config set bmad.loop.current_epic epic-<N></action>
      <action>Run: dev-story-beads</action>
      <action>GOTO step 3</action>
    </check>

    <action>5) Specs (lowest priority):</action>
    <action>Run: bd list --status open --label bmad-story,needs-spec --json</action>
    <check if="any needs-spec issues exist">
      <action>Select the issue with the smallest numeric story key label (story-N-M) and set {{issue_id}}</action>
      <action>Persist loop state: bd config set bmad.loop.current_issue {{issue_id}}</action>
      <action>If stop_mode is epic, also persist current epic key (from issue labels): bd config set bmad.loop.current_epic epic-<N></action>
      <action>Run: create-story-beads (attach BMAD STORY SPEC v1, set needs-validation)</action>
      <action>GOTO step 3</action>
    </check>

    <output>No actionable work found (no needs-review, no needs-fix, no needs-validation, no ready-for-dev, no needs-spec). Check blocked issues:</output>
    <action>Run: bd blocked --json</action>
    <action>HALT</action>
  </step>

  <step n="2" goal="(reserved) - execution happens in sub-workflows">
    <action>Execution is delegated to create-story-beads / dev-story-beads / code-review-beads.</action>
  </step>

  <step n="3" goal="Stop-mode gate">
    <action>Read stop_mode: bd config get bmad.loop.stop_mode</action>

    <check if="stop_mode == 'story'">
      <output>‚è∏Ô∏è D·ª´ng theo ch·∫ø ƒë·ªô story: {{issue_id}} ƒë√£ x·ª≠ l√Ω. Ch·∫°y l·∫°i workflow ƒë·ªÉ ti·∫øp t·ª•c issue ti·∫øp theo.</output>
      <action>GOTO step 4</action>
    </check>

    <check if="stop_mode == 'epic'">
      <action>Determine the epic for this issue (if any) using parent-child dependencies or bd epic status.</action>
      <action>Run: bd epic status</action>
      <action>If the epic containing {{issue_id}} is now complete (all children closed), then HALT.</action>
      <check if="epic is complete">
        <output>‚è∏Ô∏è D·ª´ng theo ch·∫ø ƒë·ªô epic: epic ƒë√£ ho√†n t·∫•t. Ch·∫°y l·∫°i workflow ƒë·ªÉ ti·∫øp t·ª•c epic ti·∫øp theo.</output>
        <action>GOTO step 4</action>
      </check>
    </check>

    <check if="stop_mode == 'project'">
      <output>üöÄ Project mode: continue to next unit-of-work (via restart after checkpoint).</output>
      <action>GOTO step 4</action>
    </check>
  </step>

  <step n="4" goal="Checkpoint for context clearing">
    <critical>
      After this checkpoint, it's safe to dismiss/clear agent context.
      Re-running this same workflow should resume from Beads state (bd config keys).
    </critical>
    <action>bd comments add {{issue_id}} "BMAD CHECKPOINT v1\nUnit-of-work completed. Safe to clear agent context.\nRe-run auto-sprint-loop-beads to continue (Review -> Fix -> Dev -> Spec)."</action>
    <action>HALT</action>
  </step>
</workflow>
