<workflow>
  <critical>The workflow execution engine is governed by: {project-root}/_bmad/core/tasks/workflow.xml</critical>
  <critical>You MUST have already loaded and processed: {installed_path}/workflow.yaml</critical>
  <critical>Communicate all responses in {communication_language} and language MUST be tailored to {user_skill_level}</critical>
  <critical>Generate all documents in {document_output_language}</critical>

  <critical>
    REAL Beads integration (steveyegge/beads):
    - Review targets a Beads issue and its spec (description + spec comments).
    - No interactive choices: always auto-fix HIGH+MEDIUM issues when possible.
    - If follow-ups remain, create discovered-from issues and link them.
  </critical>

  <critical>
    ATOMIC SPEC CONVENTION (v1):
    - Find the latest comment containing: \"BMAD STORY SPEC v1\" and review against it.
    - Record review results as a single append-only comment with marker: \"BMAD REVIEW v1\".
  </critical>

  <step n="1" goal="Select issue to review">
    <action>Ensure `bd` is installed and initialized.</action>
    <action>If loop orchestrator set an issue, prefer it:
      - Read: bd config get bmad.loop.current_issue
      - If set, use that as {{issue_id}} and continue.
    </action>
    <action>Select a story issue to review:
      - Prefer: bd list --status open --label bmad-story,needs-review --json (pick the oldest)
      - Or: user provides issue_id
    </action>
    <action>If selecting from the list, choose the smallest numeric story key label (story-N-M) and set {{issue_id}}.</action>
    <action>Load issue: bd show {{issue_id}} --json</action>
    <action>Load spec comments: bd comments {{issue_id}} --json (or without --json if unsupported) and select the latest \"BMAD STORY SPEC v1\" comment.</action>
    <action>Discover actual changes with git: git status --porcelain; git diff --name-only; git diff --cached --name-only</action>
    <action>Load {project_context} if exists</action>
  </step>

  <step n="2" goal="Adversarial review + auto-fix">
    <action>Validate each Acceptance Criterion against actual implementation.</action>
    <action>Find 3-10 actionable issues minimum. Categorize HIGH/MEDIUM/LOW.</action>
    <action>Auto-fix all HIGH+MEDIUM issues now when feasible (code + tests).</action>

    <action>Record review results as a single comment using this template:</action>
    <action>
      bd comments add {{issue_id}} \"BMAD REVIEW v1\\nSummary: <1-2 sentences>\\nHIGH:\\n- ...\\nMEDIUM:\\n- ...\\nLOW:\\n- ...\\nFixed in this pass:\\n- ...\\nRemaining follow-ups:\\n- ...\\nEvidence:\\n- Files: <list>\\n- Tests: <commands + results>\"
    </action>

    <check if="remaining HIGH/MEDIUM issues exist">
      <action>Create follow-up issues and link them discovered-from:
        - bd create "Follow-up: ..." -t task -p 2 --deps discovered-from:{{issue_id}} --json
      </action>
      <action>Label follow-ups for queueing (recommended): bd label add <new_id> bmad-followup</action>
      <action>Block the story on follow-ups (recommended):
        - bd dep add <new_id> {{issue_id}} --type blocks
      </action>
      <action>Keep story OPEN and request fixes:
        - bd label remove {{issue_id}} needs-review
        - bd label add {{issue_id}} needs-fix
        - bd update {{issue_id}} --status open --json
      </action>
    </check>
  </step>

  <step n="3" goal="Finalize status">
    <check if="all HIGH/MEDIUM fixed and ACs satisfied">
      <action>Close only after verified: bd close {{issue_id}} --reason "Verified" --json</action>
      <action>bd label remove {{issue_id}} needs-review</action>
      <action>bd label remove {{issue_id}} needs-fix</action>
      <action>bd label add {{issue_id}} reviewed</action>
      <action>bd label add {{issue_id}} done</action>
      <output>âœ… Review complete: {{issue_id}}</output>
    </check>

    <check if="follow-ups exist">
      <output>ðŸ”„ Follow-ups created and linked to {{issue_id}}. Continue with bd ready queue.</output>
    </check>
  </step>
</workflow>
